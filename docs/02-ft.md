FT - Functional Tests

3) RF-02 Gestion de usuarios (crear, editar, bloquear)

FT-RF02-01 Crear usuario con datos validos
- Precondiciones: actor autenticado con permiso USER_CREATE.
- Datos: username unico, email valido, rol existente, estado activo.
- Pasos: enviar solicitud de creacion de usuario.
- Resultado esperado: 201 Created; usuario persistido con id; auditoria AUD-USER_CREATED (o equivalente definido por el equipo) con before=null y after con datos principales; correlationId presente.

FT-RF02-02 Rechazar creacion de usuario duplicado
- Precondiciones: existe un usuario con mismo username o email.
- Pasos: intentar crear usuario con username o email ya registrado.
- Resultado esperado: 409 Conflict; respuesta en formato ProblemDetails; no se crea registro nuevo; se mantiene integridad de datos.

FT-RF02-03 Rechazar creacion con input invalido
- Precondiciones: actor autenticado con permiso USER_CREATE.
- Datos: email invalido o campos obligatorios vacios.
- Pasos: enviar solicitud con payload invalido.
- Resultado esperado: 400 Bad Request; detalle de validacion por campo; no se persiste usuario.

FT-RF02-04 Editar usuario existente
- Precondiciones: usuario objetivo existe; actor autenticado con permiso USER_EDIT.
- Datos: cambio de nombre visible, telefono o rol permitido.
- Pasos: enviar solicitud de actualizacion.
- Resultado esperado: 200 OK; cambios reflejados; auditoria AUD-USER_UPDATED con before y after; correlationId presente.

FT-RF02-05 Rechazar edicion de usuario inexistente
- Precondiciones: actor autenticado con permiso USER_EDIT.
- Pasos: editar un userId no existente.
- Resultado esperado: 404 Not Found; ProblemDetails; sin efectos laterales.

FT-RF02-06 Bloquear usuario activo
- Precondiciones: usuario objetivo activo; actor autenticado con permiso USER_BLOCK.
- Pasos: ejecutar accion de bloqueo.
- Resultado esperado: 200 OK; estado del usuario=blocked; auditoria AUD-03 USER_BLOCKED; timestamp y actorUserId registrados.

FT-RF02-07 Usuario bloqueado no puede operar endpoints protegidos
- Precondiciones: usuario ya bloqueado; posee token previo valido temporalmente.
- Pasos: invocar endpoint protegido (por ejemplo crear solicitud).
- Resultado esperado: 403 Forbidden; cumplimiento de RB-06; evento de seguridad/auditoria segun configuracion.

FT-RF02-08 Rechazar bloqueo de usuario inexistente
- Precondiciones: actor autenticado con permiso USER_BLOCK.
- Pasos: bloquear un userId no existente.
- Resultado esperado: 404 Not Found; sin cambios de estado ni auditoria de exito.

FT-RF02-09 RBAC en gestion de usuarios
- Precondiciones: actor autenticado sin permisos USER_CREATE/USER_EDIT/USER_BLOCK.
- Pasos: intentar crear, editar y bloquear usuarios.
- Resultado esperado: 403 Forbidden en cada accion; no hay cambios en datos.

FT-RF02-10 Trazabilidad completa en acciones criticas
- Precondiciones: existen operaciones exitosas y fallidas de crear/editar/bloquear.
- Pasos: consultar auditoria/logs por correlationId.
- Resultado esperado: cada operacion critica registra actor, accion, entityType=User, entityId, before/after (cuando aplique), at y correlationId; cumple RNF-OBS-01 y RNF-OBS-02.

Criterios de aceptacion de RF-02
- Se permite crear usuarios validos y se rechazan duplicados o payloads invalidos.
- Se permite editar usuarios existentes con control de permisos.
- Se permite bloquear usuarios y el bloqueo impide operar endpoints protegidos (RB-06).
- Todas las acciones criticas generan auditoria inmutable y logs estructurados con correlationId.
- Todas las respuestas de error siguen el contrato ProblemDetails (RNF-REL-01).
