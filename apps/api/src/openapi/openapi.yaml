openapi: 3.1.0
info:
  title: Telecom FieldOps API
  version: 1.0.0
  description: Security-focused API for authentication, user management, roles and audit-ready operations.
servers:
  - url: http://localhost:3000/api/v1

tags:
  - name: Health
  - name: Auth
  - name: Users
  - name: Roles
  - name: Plans
  - name: Catalog
  - name: Inventory

components:
  securitySchemes:
    OAuth2Password:
      type: oauth2
      flows:
        password:
          tokenUrl: /api/v1/auth/login
          scopes: {}
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  headers:
    X-Correlation-Id:  
      description: ID único de trazabilidad de la petición (UUID v4).
      schema:
        type: string
        format: uuid
        example: "550e8400-e29b-41d4-a716-446655440000"

  schemas:
    ProblemDetails:
      type: object
      required: [type, title, status, detail, instance, correlationId]
      properties:
        type:
          type: string
          example: urn:telecom:error:validation
        title:
          type: string
          example: Validation Error
        status:
          type: integer
          example: 400
        detail:
          type: string
          example: Request body validation failed.
        instance:
          type: string
          example: /api/v1/users
        correlationId:
          type: string
          example: c123
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string

    Role:
      type: object
      required: [id, name, permissionKeys]
      properties:
        id:
          type: string
        name:
          type: string
        permissionKeys:
          type: array
          items:
            type: string

    UserPublic:
      type: object
      required: [id, email, blocked, roles]
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        blocked:
          type: boolean
        roles:
          type: array
          items:
            type: string

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8

    LoginResponse:
      type: object
      required: [accessToken, refreshToken, tokenType, expiresIn, refreshExpiresIn, user]
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string
        tokenType:
          type: string
          example: Bearer
        expiresIn:
          type: integer
          example: 3600
        refreshExpiresIn:
          type: integer
          example: 604800
        user:
          allOf:
            - $ref: '#/components/schemas/UserPublic'
            - type: object
              required: [permissions]
              properties:
                permissions:
                  type: array
                  items:
                    type: string

    RefreshRequest:
      type: object
      required: [refreshToken]
      properties:
        refreshToken:
          type: string

    CreateUserRequest:
      type: object
      required: [email, password, roles]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        roles:
          type: array
          minItems: 1
          items:
            type: string

    UpdateUserRequest:
      type: object
      minProperties: 1
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        blocked:
          type: boolean
        roles:
          type: array
          minItems: 1
          items:
            type: string

    AuditEvent:
      type: object
      required: [id, at, actorUserId, action, entityType, entityId]
      properties:
        id: { type: string }
        at: { type: string, format: date-time }
        actorUserId: { type: string, nullable: true }
        action: { type: string }
        entityType: { type: string }
        entityId: { type: string }
        before: { type: object, additionalProperties: true, nullable: true }
        after: { type: object, additionalProperties: true, nullable: true }
        correlationId: { type: string }

    Plan:
      type: object
      required:
        - id
        - name
        - type
        - price
        - currency
        - isActive
        - description
        - category
        - status
        - monthlyPrice
      properties:
        id: { type: string }
        name: { type: string }
        type: { type: string, enum: [HOME_INTERNET, MOBILE_DATA, VOICE, TV, BUSINESS] }
        price: { type: number }
        currency: { type: string, enum: [DOP, USD] }
        isActive: { type: boolean }
        description: { type: string }
        category: { type: string, enum: [RESIDENCIAL, MOVIL, EMPRESARIAL, TV] }
        status: { type: string, enum: [ACTIVE, INACTIVE] }
        monthlyPrice: { type: number }
        downloadSpeedMbps: { type: integer, nullable: true }
        uploadSpeedMbps: { type: integer, nullable: true }
        dataLimitGB: { type: integer, nullable: true }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    CreatePlanRequest:
      type: object
      required: [name, type, price, currency]
      properties:
        name: { type: string }
        type: { type: string, enum: [HOME_INTERNET, MOBILE_DATA, VOICE, TV, BUSINESS] }
        price: { type: number, minimum: 0 }
        currency: { type: string, enum: [DOP, USD] }
        isActive: { type: boolean }
        description: { type: string }
        category: { type: string, enum: [RESIDENCIAL, MOVIL, EMPRESARIAL, TV] }
        downloadSpeedMbps: { type: integer, minimum: 0, nullable: true }
        uploadSpeedMbps: { type: integer, minimum: 0, nullable: true }
        dataLimitGB: { type: integer, minimum: 0, nullable: true }

    UpdatePlanRequest:
      type: object
      minProperties: 1
      properties:
        name: { type: string }
        type: { type: string, enum: [HOME_INTERNET, MOBILE_DATA, VOICE, TV, BUSINESS] }
        price: { type: number, minimum: 0 }
        currency: { type: string, enum: [DOP, USD] }
        isActive: { type: boolean }
        description: { type: string }
        category: { type: string, enum: [RESIDENCIAL, MOVIL, EMPRESARIAL, TV] }
        status: { type: string, enum: [ACTIVE, INACTIVE] }
        monthlyPrice: { type: number, minimum: 0 }
        downloadSpeedMbps: { type: integer, minimum: 0, nullable: true }
        uploadSpeedMbps: { type: integer, minimum: 0, nullable: true }
        dataLimitGB: { type: integer, minimum: 0, nullable: true }

    Product:
      type: object
      required: [id, name, category, isSerialized]
      properties:
        id: { type: string }
        name: { type: string }
        category: { type: string, enum: [ROUTER, MODEM, ONT, STB, ANTENNA, CABLE, PHONE, TABLET, LAPTOP, SIM] }
        isSerialized: { type: boolean }

    Branch:
      type: object
      required: [id, name, isMain]
      properties:
        id: { type: string }
        name: { type: string }
        isMain: { type: boolean }

    InventoryItem:
      type: object
      required: [id, branchId, productId, qtyAvailable, qtyReserved]
      properties:
        id: { type: string }
        branchId: { type: string }
        productId: { type: string }
        qtyAvailable: { type: integer }
        qtyReserved: { type: integer }
        updatedAt: { type: string, format: date-time, nullable: true }

    ReserveInventoryRequest:
      type: object
      required: [workOrderId, branchId, items]
      properties:
        workOrderId: { type: string }
        branchId: { type: string }
        items:
          type: array
          minItems: 1
          items:
            type: object
            required: [productId, qty]
            properties:
              productId: { type: string }
              qty: { type: integer, minimum: 1 }

    ReservationRecord:
      type: object
      required: [workOrderId, branchId, items, reservedAt]
      properties:
        workOrderId: { type: string }
        branchId: { type: string }
        items:
          type: array
          items:
            type: object
            required: [productId, qty]
            properties:
              productId: { type: string }
              qty: { type: integer }
        reservedAt: { type: string, format: date-time }

    SyncImportRequest:
      type: object
      required: [meta, operations]
      properties:
        meta:
          type: object
          required: [exportedAt, deviceId, appVersion]
          properties:
            exportedAt: { type: string, format: date-time }
            deviceId: { type: string }
            appVersion: { type: string }
        operations:
          type: array
          items:
            type: object
            required: [opId, entityType, entityId, operation, payload, createdAt, createdBy, baseVersion, correlationId]
            properties:
              opId: { type: string }
              entityType: { type: string, enum: [workOrder] }
              entityId: { type: string }
              operation: { type: string, enum: [CHANGE_STATUS, ADD_NOTE] }
              payload: { type: object, additionalProperties: true }
              createdAt: { type: string, format: date-time }
              createdBy: { type: string }
              baseVersion: { type: integer }
              correlationId: { type: string }

    SyncImportResponse:
      type: object
      required: [appliedCount, conflictCount, conflicts]
      properties:
        appliedCount: { type: integer }
        conflictCount: { type: integer }
        conflicts:
          type: array
          items:
            type: object
            required: [opId, entityId, reason]
            properties:
              opId: { type: string }
              entityId: { type: string }
              reason: { type: string }

  responses:
    BadRequest:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    TooManyRequests:
      description: Too many requests
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'

security:
  - BearerAuth: []

paths:
  /health:
    get:
      tags: [Health]
      security: []
      responses:
        '200':
          description: ok
          content:
            text/plain:
              schema:
                type: string
                example: ok

  /auth/login:
    post:
      tags: [Auth]
      security: []
      summary: Login with email and password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Token pair issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /auth/refresh:
    post:
      tags: [Auth]
      security: []
      summary: Rotate refresh token and issue a new token pair
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: New token pair issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /auth/logout:
    post:
      tags: [Auth]
      security: []
      summary: Revoke refresh token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: Logged out
          content:
            application/json:
              schema:
                type: object
                required: [success]
                properties:
                  success:
                    type: boolean
                    example: true
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /users:
    get:
      tags: [Users]
      summary: List users
      responses:
        '200':
          description: Users list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserPublic'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
    post:
      tags: [Users]
      summary: Create user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPublic'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /users/{id}:
    patch:
      tags: [Users]
      summary: Update user data and roles
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: User updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPublic'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'

  /users/{id}/block:
    post:
      tags: [Users]
      summary: Block user
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User blocked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPublic'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /roles:
    get:
      tags: [Roles]
      summary: List roles and permission keys
      responses:
        '200':
          description: Roles list
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Role" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /catalog/plans:
    get:
      tags: [Plans]
      summary: List plans
      responses:
        "200":
          description: plans list
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Plan" }
    post:
      tags: [Plans]
      summary: Create plan
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreatePlanRequest" }
      responses:
        "201":
          description: plan created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Plan" }
        "400": { $ref: "#/components/responses/BadRequest" }

  /catalog/plans/{id}:
    get:
      tags: [Plans]
      summary: Get plan by id
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        "200":
          description: plan detail
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Plan" }
        "404": { $ref: "#/components/responses/NotFound" }
    patch:
      tags: [Plans]
      summary: Update plan
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/UpdatePlanRequest" }
      responses:
        "200":
          description: plan updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Plan" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "404": { $ref: "#/components/responses/NotFound" }
    delete:
      tags: [Plans]
      summary: Delete plan
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        "204":
          description: plan deleted
        "404": { $ref: "#/components/responses/NotFound" }

  /catalog/plans/{id}/activate:
    patch:
      tags: [Plans]
      summary: Activate plan
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        "200":
          description: plan activated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Plan" }
        "404": { $ref: "#/components/responses/NotFound" }

  /catalog/plans/{id}/deactivate:
    patch:
      tags: [Plans]
      summary: Deactivate plan
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        "200":
          description: plan deactivated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Plan" }
        "404": { $ref: "#/components/responses/NotFound" }

  /catalog/products:
    get:
      tags: [Catalog]
      responses:
        "200":
          description: list products
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Product"}
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }
  
  /inventory:
    get:
      tags: [Inventory]
      parameters:
        - name: branchId
          in: query
          required: true
          schema: { type: string }
      responses:
        "200":
          description: inventory list
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/InventoryItem" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /inventory/branches:
    get:
      tags: [Inventory]
      responses:
        "200":
          description: branches list
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Branch" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /inventory/products:
    get:
      tags: [Inventory]
      responses:
        "200":
          description: products available for inventory operations
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Product" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /inventory/reservations:
    post:
      tags: [Inventory]
      summary: Reserve inventory for a work order request
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ReserveInventoryRequest" }
      responses:
        "201":
          description: reservation created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ReservationRecord" }
        "400":
          description: validation error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
        "409":
          description: insufficient stock / conflict
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /inventory/reservations/{workOrderId}:
    delete:
      tags: [Inventory]
      summary: Release reservation for a work order
      parameters:
        - name: workOrderId
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: reservation released
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ReservationRecord" }
        "404":
          description: reservation not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
        "400":
          description: invalid request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /sync/import:
    post:
      tags: [Sync]
      summary: Apply offline exported operations
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/SyncImportRequest" }
      responses:
        "200":
          description: import result
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SyncImportResponse" }
        "400":
          description: schema invalid
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }



  /audit:
    get:
      tags: [Audit]
      parameters:
        - name: entityType
          in: query
          required: false
          schema: { type: string }
        - name: entityId
          in: query
          required: false
          schema: { type: string }
        - name: action
          in: query
          required: false
          schema: { type: string }
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        "200":
          description: paginated list of audit events
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: "#/components/schemas/AuditEvent" }
                  pagination:
                    type: object
                    properties:
                      total: { type: integer }
                      limit: { type: integer }
                      offset: { type: integer }
                      hasMore: { type: boolean }
              examples:
                success:
                  summary: List of audit events with pagination
                  value:
                    items:
                      - id: "evt-001"
                        at: "2026-02-27T14:30:00Z"
                        actorUserId: "user-123"
                        action: "CREATE"
                        entityType: "WorkOrder"
                        entityId: "wo-456"
                        correlationId: "550e8400-e29b-41d4-a716"
                    pagination:
                      total: 150
                      limit: 50
                      offset: 0
                      hasMore: true
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /audit/{auditId}:
    get:
      tags: [Audit]
      summary: Retrieve a single audit event by id
      parameters:
        - name: auditId
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: single audit event
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AuditEvent" }
              examples:
                success:
                  summary: Single audit event
                  value:
                    id: "evt-001"
                    at: "2026-02-27T14:30:00Z"
                    actorUserId: "user-123"
                    action: "CREATE"
                    entityType: "WorkOrder"
                    entityId: "wo-456"
                    before: null
                    after:
                      status: "OPEN"
                      technician: "Torres"
                    correlationId: "550e8400-e29b-41d4-a716"
        "404":
          description: not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /audit/entity/{entityType}/{entityId}:
    get:
      tags: [Audit]
      summary: Get history for a specific entity
      parameters:
        - name: entityType
          in: path
          required: true
          schema: { type: string }
        - name: entityId
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: audit history of an entity
          content:
            application/json:
              schema:
                type: object
                properties:
                  entity:
                    type: object
                    properties:
                      type: { type: string }
                      id: { type: string }
                  events:
                    type: array
                    items: { $ref: "#/components/schemas/AuditEvent" }
                  total: { type: integer }
              examples:
                success:
                  summary: Entity audit history
                  value:
                    entity:
                      type: "WorkOrder"
                      id: "wo-456"
                    events:
                      - id: "evt-001"
                        at: "2026-02-27T14:30:00Z"
                        actorUserId: "user-123"
                        action: "CREATE"
                        entityType: "WorkOrder"
                        entityId: "wo-456"
                      - id: "evt-002"
                        at: "2026-02-27T15:45:00Z"
                        actorUserId: "user-456"
                        action: "UPDATE"
                        entityType: "WorkOrder"
                        entityId: "wo-456"
                    total: 2
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /audit/user/{userId}:
    get:
      tags: [Audit]
      summary: Get events performed by a user
      parameters:
        - name: userId
          in: path
          required: true
          schema: { type: string }
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 1000
      responses:
        "200":
          description: audit events by user
          content:
            application/json:
              schema:
                type: object
                properties:
                  user: { type: string }
                  events:
                    type: array
                    items: { $ref: "#/components/schemas/AuditEvent" }
                  count: { type: integer }
              examples:
                success:
                  summary: Events performed by user
                  value:
                    user: "user-123"
                    events:
                      - id: "evt-001"
                        at: "2026-02-27T14:30:00Z"
                        actorUserId: "user-123"
                        action: "CREATE"
                        entityType: "WorkOrder"
                        entityId: "wo-456"
                        correlationId: "550e8400-e29b-41d4-a716"
                      - id: "evt-003"
                        at: "2026-02-26T09:20:00Z"
                        actorUserId: "user-123"
                        action: "RESERVE"
                        entityType: "InventoryItem"
                        entityId: "inv-112"
                        correlationId: "550e8400-e29b-41d4-a718"
                    count: 2
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /audit/search:
    get:
      tags: [Audit]
      summary: Search audit events with criteria
      parameters:
        - name: action
          in: query
          required: false
          schema: { type: string }
        - name: entityType
          in: query
          required: false
          schema: { type: string }
        - name: startDate
          in: query
          required: false
          schema: { type: string, format: date-time }
        - name: endDate
          in: query
          required: false
          schema: { type: string, format: date-time }
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        "200":
          description: audit events
          content:
            application/json:
              schema:
                type: object
                properties:
                  criteria:
                    type: object
                    properties:
                      action: { type: string, nullable: true }
                      entityType: { type: string, nullable: true }
                      startDate: { type: string, format: date-time, nullable: true }
                      endDate: { type: string, format: date-time, nullable: true }
                  events:
                    type: array
                    items: { $ref: "#/components/schemas/AuditEvent" }
                  count: { type: integer }
              examples:
                success:
                  summary: Search results with date range
                  value:
                    criteria:
                      action: "CREATE"
                      entityType: "WorkOrder"
                      startDate: "2026-02-25T00:00:00Z"
                      endDate: "2026-02-27T23:59:59Z"
                    events:
                      - id: "evt-001"
                        at: "2026-02-27T14:30:00Z"
                        actorUserId: "user-123"
                        action: "CREATE"
                        entityType: "WorkOrder"
                        entityId: "wo-456"
                        correlationId: "550e8400-e29b-41d4-a716"
                    count: 1
        "400":
          description: validation error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }


  /kpis/summary:
    get:
      tags: [KPIs]
      responses:
        "200":
          description: kpi summary
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }
