openapi: 3.1.0
info:
  title: Telecom FieldOps API
  version: 1.0.0
  description: Security-focused API for authentication, user management, roles and audit-ready operations.
servers:
  - url: http://localhost:3000/api/v1

tags:
  - name: Health
  - name: Auth
  - name: Users
  - name: Roles

components:
  securitySchemes:
    OAuth2Password:
      type: oauth2
      flows:
        password:
          tokenUrl: /api/v1/auth/login
          scopes: {}
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ProblemDetails:
      type: object
      required: [type, title, status, detail, instance, correlationId]
      properties:
        type:
          type: string
          example: urn:telecom:error:validation
        title:
          type: string
          example: Validation Error
        status:
          type: integer
          example: 400
        detail:
          type: string
          example: Request body validation failed.
        instance:
          type: string
          example: /api/v1/users
        correlationId:
          type: string
          example: c123
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string

    Role:
      type: object
      required: [id, name, permissionKeys]
      properties:
        id:
          type: string
        name:
          type: string
        permissionKeys:
          type: array
          items:
            type: string

    UserPublic:
      type: object
      required: [id, email, blocked, roles]
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        blocked:
          type: boolean
        roles:
          type: array
          items:
            type: string

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8

    LoginResponse:
      type: object
      required: [accessToken, refreshToken, tokenType, expiresIn, refreshExpiresIn, user]
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string
        tokenType:
          type: string
          example: Bearer
        expiresIn:
          type: integer
          example: 3600
        refreshExpiresIn:
          type: integer
          example: 604800
        user:
          allOf:
            - $ref: '#/components/schemas/UserPublic'
            - type: object
              required: [permissions]
              properties:
                permissions:
                  type: array
                  items:
                    type: string

    RefreshRequest:
      type: object
      required: [refreshToken]
      properties:
        refreshToken:
          type: string

    CreateUserRequest:
      type: object
      required: [email, password, roles]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        roles:
          type: array
          minItems: 1
          items:
            type: string

    UpdateUserRequest:
      type: object
      minProperties: 1
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        blocked:
          type: boolean
        roles:
          type: array
          minItems: 1
          items:
            type: string

    AuditEvent:
      type: object
      required: [id, at, actorUserId, action, entityType, entityId]
      properties:
        id: { type: string }
        at: { type: string, format: date-time }
        actorUserId: { type: string, nullable: true }
        action: { type: string }
        entityType: { type: string }
        entityId: { type: string }
        before: { type: object, additionalProperties: true, nullable: true }
        after: { type: object, additionalProperties: true, nullable: true }
        correlationId: { type: string }

    Plan:
      type: object
      required: [id, name, type, price, currency, isActive]
      properties:
        id: { type: string }
        name: { type: string }
        type: { type: string, enum: [HOME_INTERNET, MOBILE_DATA, VOICE, TV, BUSINESS] }
        price: { type: number }
        currency: { type: string, enum: [DOP, USD] }
        isActive: { type: boolean }

    Product:
      type: object
      required: [id, name, category, isSerialized]
      properties:
        id: { type: string }
        name: { type: string }
        category: { type: string, enum: [ROUTER, MODEM, ONT, STB, ANTENNA, CABLE, PHONE, TABLET, LAPTOP, SIM] }
        isSerialized: { type: boolean }

    Branch:
      type: object
      required: [id, name, isMain]
      properties:
        id: { type: string }
        name: { type: string }
        isMain: { type: boolean }

    InventoryItem:
      type: object
      required: [id, branchId, productId, qtyAvailable, qtyReserved]
      properties:
        id: { type: string }
        branchId: { type: string }
        productId: { type: string }
        qtyAvailable: { type: integer }
        qtyReserved: { type: integer }
        updatedAt: { type: string, format: date-time, nullable: true }

    SyncImportRequest:
      type: object
      required: [meta, operations]
      properties:
        meta:
          type: object
          required: [exportedAt, deviceId, appVersion]
          properties:
            exportedAt: { type: string, format: date-time }
            deviceId: { type: string }
            appVersion: { type: string }
        operations:
          type: array
          items:
            type: object
            required: [opId, entityType, entityId, operation, payload, createdAt, createdBy, baseVersion, correlationId]
            properties:
              opId: { type: string }
              entityType: { type: string, enum: [workOrder] }
              entityId: { type: string }
              operation: { type: string, enum: [CHANGE_STATUS, ADD_NOTE] }
              payload: { type: object, additionalProperties: true }
              createdAt: { type: string, format: date-time }
              createdBy: { type: string }
              baseVersion: { type: integer }
              correlationId: { type: string }

    SyncImportResponse:
      type: object
      required: [appliedCount, conflictCount, conflicts]
      properties:
        appliedCount: { type: integer }
        conflictCount: { type: integer }
        conflicts:
          type: array
          items:
            type: object
            required: [opId, entityId, reason]
            properties:
              opId: { type: string }
              entityId: { type: string }
              reason: { type: string }

  responses:
    BadRequest:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    TooManyRequests:
      description: Too many requests
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'

security:
  - BearerAuth: []

paths:
  /health:
    get:
      tags: [Health]
      security: []
      responses:
        '200':
          description: ok
          content:
            text/plain:
              schema:
                type: string
                example: ok

  /auth/login:
    post:
      tags: [Auth]
      security: []
      summary: Login with email and password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Token pair issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /auth/refresh:
    post:
      tags: [Auth]
      security: []
      summary: Rotate refresh token and issue a new token pair
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: New token pair issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /auth/logout:
    post:
      tags: [Auth]
      security: []
      summary: Revoke refresh token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: Logged out
          content:
            application/json:
              schema:
                type: object
                required: [success]
                properties:
                  success:
                    type: boolean
                    example: true
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /users:
    get:
      tags: [Users]
      summary: List users
      responses:
        '200':
          description: Users list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserPublic'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
    post:
      tags: [Users]
      summary: Create user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPublic'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/TooManyRequests'

  /users/{id}:
    patch:
      tags: [Users]
      summary: Update user data and roles
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: User updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPublic'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'

  /users/{id}/block:
    post:
      tags: [Users]
      summary: Block user
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User blocked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPublic'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /roles:
    get:
      tags: [Roles]
      summary: List roles and permission keys
      responses:
        '200':
          description: Roles list
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Role" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /catalog/plans:
    get:
      tags: [Catalog]
      responses:
        "200":
          description: list plans
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Plan" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /catalog/products:
    get:
      tags: [Catalog]
      responses:
        "200":
          description: list products
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Product"}
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }
  
  /inventory:
    get:
      tags: [Inventory]
      parameters:
        - name: branchId
          in: query
          required: true
          schema: { type: string }
      responses:
        "200":
          description: inventory list
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/InventoryItem" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /inventory/branches:
    get:
      tags: [Inventory]
      responses:
        "200":
          description: branches list
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Branch" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /inventory/products:
    get:
      tags: [Inventory]
      responses:
        "200":
          description: products available for inventory operations
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Product" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }


  /sync/import:
    post:
      tags: [Sync]
      summary: Apply offline exported operations
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/SyncImportRequest" }
      responses:
        "200":
          description: import result
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SyncImportResponse" }
        "400":
          description: schema invalid
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }



  /audit:
    get:
      tags: [Audit]
      parameters:
        - name: entityType
          in: query
          required: false
          schema: { type: string }
        - name: entityId
          in: query
          required: false
          schema: { type: string }
      responses:
        "200":
          description: audit events
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/AuditEvent" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /kpis/summary:
    get:
      tags: [KPIs]
      responses:
        "200":
          description: kpi summary
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }
