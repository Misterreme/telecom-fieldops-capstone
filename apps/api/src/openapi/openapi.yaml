openapi: 3.1.0
info:
  title: Telecom FieldOps API
  version: 1.0.0
  description: API first contract for operations, inventory, and work orders with audit and security.
servers:
  - url: https://example.com/api/v1

tags:
  - name: Auth
  - name: Users
  - name: Roles
  - name: Catalog
  - name: Inventory
  - name: WorkOrders
  - name: Audit
  - name: KPIs

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  headers:
    X-Correlation-Id:  
      description: ID único de trazabilidad de la petición (UUID v4).
      schema:
        type: string
        format: uuid
        example: "550e8400-e29b-41d4-a716-446655440000"

  schemas:
    ProblemDetails:
      type: object
      required: [type, title, status, detail, correlationId]
      properties:
        type: { type: string, example: "urn:telecom:error:validation" }
        title: { type: string, example: "Validation error" }
        status: { type: integer, example: 400 }
        detail: { type: string, example: "Invalid input." }
        instance: { type: string, example: "/api/v1/work-orders" }
        correlationId: { type: string, example: "c_123abc" }
        errors:
          type: object
          additionalProperties:
            type: array
            items: { type: string }

    AuditEvent:
      type: object
      required: [id, at, actorUserId, action, entityType, entityId]
      properties:
        id: { type: string, example: "aud_1001" }
        at: { type: string, format: date-time }
        actorUserId: { type: string, example: "usr_001" }
        action: { type: string, example: "WORK_ORDER_STATUS_CHANGED" }
        entityType: { type: string, example: "workOrder" }
        entityId: { type: string, example: "wo_10021" }
        before: { type: object, additionalProperties: true }
        after: { type: object, additionalProperties: true }
        correlationId: { type: string, example: "c_123abc" }

    User:
      type: object
      required: [id, username, displayName, isActive]
      properties:
        id: { type: string }
        username: { type: string }
        displayName: { type: string }
        isActive: { type: boolean }
        roleIds:
          type: array
          items: { type: string }

    Role:
      type: object
      required: [id, name, permissionKeys]
      properties:
        id: { type: string }
        name: { type: string }
        permissionKeys:
          type: array
          items: { type: string }

    Plan:
      type: object
      required: [id, name, type, price, currency, isActive]
      properties:
        id: { type: string }
        name: { type: string }
        type: { type: string, enum: [HOME_INTERNET, MOBILE_DATA, VOICE, TV, BUSINESS] }
        price: { type: number }
        currency: { type: string, enum: [DOP, USD] }
        isActive: { type: boolean }

    Product:
      type: object
      required: [id, name, category, isSerialized]
      properties:
        id: { type: string }
        name: { type: string }
        category: { type: string, enum: [ROUTER, MODEM, ONT, STB, ANTENNA, CABLE, PHONE, TABLET, LAPTOP, SIM] }
        isSerialized: { type: boolean }

    InventoryItem:
      type: object
      required: [id, branchId, productId, qtyAvailable, qtyReserved, updatedAt]
      properties:
        id: { type: string }
        branchId: { type: string }
        productId: { type: string }
        qtyAvailable: { type: integer }
        qtyReserved: { type: integer }
        updatedAt: { type: string, format: date-time }

    WorkOrderType:
      type: string
      enum:
        - NEW_SERVICE_INSTALL
        - CLAIM_TROUBLESHOOT
        - PLAN_AND_EQUIPMENT_SALE
        - MONTHLY_PAYMENT
        - EQUIPMENT_REPLACEMENT
        - SERVICE_UPGRADE
        - SERVICE_DOWN_OUTAGE
        - SIM_REPLACEMENT

    WorkOrderStatus:
      type: string
      enum:
        - DRAFT
        - SUBMITTED
        - IN_REVIEW
        - ELIGIBILITY_CHECK
        - INVENTORY_RESERVATION
        - SCHEDULED
        - IN_PROGRESS
        - VERIFICATION
        - COMPLETED
        - CANCELLED
        - REJECTED
        - ON_HOLD
        - CONFLICT

    WorkOrder:
      type: object
      required: [id, type, status, customerId, createdAt]
      properties:
        id: { type: string }
        type: { $ref: "#/components/schemas/WorkOrderType" }
        status: { $ref: "#/components/schemas/WorkOrderStatus" }
        customerId: { type: string }
        branchId: { type: string }
        planId: { type: string, nullable: true }
        requestedProducts:
          type: array
          items:
            type: object
            required: [productId, qty]
            properties:
              productId: { type: string }
              qty: { type: integer, minimum: 1 }
        notes: { type: string, nullable: true }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    CreateWorkOrderRequest:
      type: object
      required: [type, customerId, branchId]
      properties:
        type: { $ref: "#/components/schemas/WorkOrderType" }
        customerId: { type: string }
        branchId: { type: string }
        planId: { type: string, nullable: true }
        requestedProducts:
          type: array
          items:
            type: object
            required: [productId, qty]
            properties:
              productId: { type: string }
              qty: { type: integer, minimum: 1 }
        notes: { type: string, maxLength: 500, nullable: true }

    ChangeWorkOrderStatusRequest:
      type: object
      required: [newStatus, reason]
      properties:
        newStatus: { $ref: "#/components/schemas/WorkOrderStatus" }
        reason: { type: string, minLength: 3, maxLength: 200 }

    
    SyncImportRequest:
      type: object
      required: [meta, operations]
      properties:
        meta:
          type: object
          required: [exportedAt, deviceId, appVersion]
          properties:
            exportedAt: { type: string, format: date-time }
            deviceId: { type: string }
            appVersion: { type: string }
        operations:
          type: array
          items:
            type: object
            required: [opId, entityType, entityId, operation, payload, createdAt, createdBy, baseVersion, correlationId]
            properties:
              opId: { type: string }
              entityType: { type: string, enum: [workOrder] }
              entityId: { type: string }
              operation: { type: string, enum: [CHANGE_STATUS, ADD_NOTE] }
              payload: { type: object, additionalProperties: true }
              createdAt: { type: string, format: date-time }
              createdBy: { type: string }
              baseVersion: { type: integer }
              correlationId: { type: string }

    SyncImportResponse:
      type: object
      required: [appliedCount, conflictCount, conflicts]
      properties:
        appliedCount: { type: integer }
        conflictCount: { type: integer }
        conflicts:
          type: array
          items:
            type: object
            required: [opId, entityId, reason]
            properties:
              opId: { type: string }
              entityId: { type: string }
              reason: { type: string, example: "Version mismatch: server=5 client=3" }

  responses:
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ProblemDetails" }
    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ProblemDetails" }

security:
  - BearerAuth: []

paths:
  /health:
    get:
      security: []
      tags: [Health]
      responses:
        "200":
          description: ok

  /auth/login:
    post:
      security: []
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, password]
              properties:
                username: { type: string }
                password: { type: string }
      responses:
        "200":
          description: token issued
          content:
            application/json:
              schema:
                type: object
                required: [accessToken, expiresAt]
                properties:
                  accessToken: { type: string }
                  expiresAt: { type: string, format: date-time }
        "401":
          $ref: "#/components/responses/Unauthorized"

  /users:
    get:
      tags: [Users]
      responses:
        "200":
          description: list users
          headers:
            X-Correlation-Id:
              $ref: "#/components/headers/X-Correlation-Id"
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/User" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /users/{userId}/block:
    post:
      tags: [Users]
      parameters:
        - name: userId
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: blocked
          headers:
            X-Correlation-Id:
              $ref: "#/components/headers/X-Correlation-Id"
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /work-orders:
    post:
      tags: [WorkOrders]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreateWorkOrderRequest" }
      responses:
        "201":
          description: created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/WorkOrder" }
        "400":
          description: validation error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
        "409":
          description: conflict
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /work-orders/{workOrderId}/status:
    patch:
      tags: [WorkOrders]
      parameters:
        - name: workOrderId
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ChangeWorkOrderStatusRequest" }
      responses:
        "200":
          description: updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/WorkOrder" }
        "409":
          description: invalid transition / conflict
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }

    
  /roles:
    get:
      tags: [Roles]
      responses:
        "200":
          description: list roles
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Role" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }      

  /catalog/plans:
    get:
      tags: [Catalog]
      responses:
        "200":
          description: list plans
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Plan" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /catalog/products:
    get:
      tags: [Catalog]
      responses:
        "200":
          description: list products
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Product"}
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }
  
  /inventory:
    get:
      tags: [Inventory]
      parameters:
        - name: branchId
          in: query
          required: true
          schema: { type: string }
      responses:
        "200":
          description: inventory list
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/InventoryItem" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }



  /sync/import:
    post:
      tags: [Sync]
      summary: Apply offline exported operations
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/SyncImportRequest" }
      responses:
        "200":
          description: import result
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SyncImportResponse" }
        "400":
          description: schema invalid
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }



  /audit:
    get:
      tags: [Audit]
      parameters:
        - name: entityType
          in: query
          required: false
          schema: { type: string }
        - name: entityId
          in: query
          required: false
          schema: { type: string }
        - name: action
          in: query
          required: false
          schema: { type: string }
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        "200":
          description: paginated list of audit events
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: "#/components/schemas/AuditEvent" }
                  pagination:
                    type: object
                    properties:
                      total: { type: integer }
                      limit: { type: integer }
                      offset: { type: integer }
                      hasMore: { type: boolean }
              examples:
                success:
                  summary: List of audit events with pagination
                  value:
                    items:
                      - id: "evt-001"
                        at: "2026-02-27T14:30:00Z"
                        actorUserId: "user-123"
                        action: "CREATE"
                        entityType: "WorkOrder"
                        entityId: "wo-456"
                        correlationId: "550e8400-e29b-41d4-a716"
                    pagination:
                      total: 150
                      limit: 50
                      offset: 0
                      hasMore: true
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /audit/{auditId}:
    get:
      tags: [Audit]
      summary: Retrieve a single audit event by id
      parameters:
        - name: auditId
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: single audit event
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AuditEvent" }
              examples:
                success:
                  summary: Single audit event
                  value:
                    id: "evt-001"
                    at: "2026-02-27T14:30:00Z"
                    actorUserId: "user-123"
                    action: "CREATE"
                    entityType: "WorkOrder"
                    entityId: "wo-456"
                    before: null
                    after:
                      status: "OPEN"
                      technician: "Torres"
                    correlationId: "550e8400-e29b-41d4-a716"
        "404":
          description: not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /audit/entity/{entityType}/{entityId}:
    get:
      tags: [Audit]
      summary: Get history for a specific entity
      parameters:
        - name: entityType
          in: path
          required: true
          schema: { type: string }
        - name: entityId
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: audit history of an entity
          content:
            application/json:
              schema:
                type: object
                properties:
                  entity:
                    type: object
                    properties:
                      type: { type: string }
                      id: { type: string }
                  events:
                    type: array
                    items: { $ref: "#/components/schemas/AuditEvent" }
                  total: { type: integer }
              examples:
                success:
                  summary: Entity audit history
                  value:
                    entity:
                      type: "WorkOrder"
                      id: "wo-456"
                    events:
                      - id: "evt-001"
                        at: "2026-02-27T14:30:00Z"
                        actorUserId: "user-123"
                        action: "CREATE"
                        entityType: "WorkOrder"
                        entityId: "wo-456"
                      - id: "evt-002"
                        at: "2026-02-27T15:45:00Z"
                        actorUserId: "user-456"
                        action: "UPDATE"
                        entityType: "WorkOrder"
                        entityId: "wo-456"
                    total: 2
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /audit/user/{userId}:
    get:
      tags: [Audit]
      summary: Get events performed by a user
      parameters:
        - name: userId
          in: path
          required: true
          schema: { type: string }
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 1000
      responses:
        "200":
          description: audit events by user
          content:
            application/json:
              schema:
                type: object
                properties:
                  user: { type: string }
                  events:
                    type: array
                    items: { $ref: "#/components/schemas/AuditEvent" }
                  count: { type: integer }
              examples:
                success:
                  summary: Events performed by user
                  value:
                    user: "user-123"
                    events:
                      - id: "evt-001"
                        at: "2026-02-27T14:30:00Z"
                        actorUserId: "user-123"
                        action: "CREATE"
                        entityType: "WorkOrder"
                        entityId: "wo-456"
                        correlationId: "550e8400-e29b-41d4-a716"
                      - id: "evt-003"
                        at: "2026-02-26T09:20:00Z"
                        actorUserId: "user-123"
                        action: "RESERVE"
                        entityType: "InventoryItem"
                        entityId: "inv-112"
                        correlationId: "550e8400-e29b-41d4-a718"
                    count: 2
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /audit/search:
    get:
      tags: [Audit]
      summary: Search audit events with criteria
      parameters:
        - name: action
          in: query
          required: false
          schema: { type: string }
        - name: entityType
          in: query
          required: false
          schema: { type: string }
        - name: startDate
          in: query
          required: false
          schema: { type: string, format: date-time }
        - name: endDate
          in: query
          required: false
          schema: { type: string, format: date-time }
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        "200":
          description: audit events
          content:
            application/json:
              schema:
                type: object
                properties:
                  criteria:
                    type: object
                    properties:
                      action: { type: string, nullable: true }
                      entityType: { type: string, nullable: true }
                      startDate: { type: string, format: date-time, nullable: true }
                      endDate: { type: string, format: date-time, nullable: true }
                  events:
                    type: array
                    items: { $ref: "#/components/schemas/AuditEvent" }
                  count: { type: integer }
              examples:
                success:
                  summary: Search results with date range
                  value:
                    criteria:
                      action: "CREATE"
                      entityType: "WorkOrder"
                      startDate: "2026-02-25T00:00:00Z"
                      endDate: "2026-02-27T23:59:59Z"
                    events:
                      - id: "evt-001"
                        at: "2026-02-27T14:30:00Z"
                        actorUserId: "user-123"
                        action: "CREATE"
                        entityType: "WorkOrder"
                        entityId: "wo-456"
                        correlationId: "550e8400-e29b-41d4-a716"
                    count: 1
        "400":
          description: validation error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProblemDetails" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }


  /kpis/summary:
    get:
      tags: [KPIs]
      responses:
        "200":
          description: kpi summary
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }